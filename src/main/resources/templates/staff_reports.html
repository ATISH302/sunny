<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒƒãƒ•ï¼šé€šå ±ä¸€è¦§</title>

    <!-- å…±é€šCSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<!-- ===== å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
<header class="site-header">
    <div class="header-inner">
        <!-- å·¦ï¼šãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ -->
        <button class="hamburger" type="button" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="toggleMenu()">â˜°</button>

        <!-- ä¸­å¤®ï¼šåº—å -->
        <div class="brand">
            <div class="brand-title">SUNåº— ãƒãƒƒãƒˆäºˆç´„ãƒ»é€šè²©ã‚µã‚¤ãƒˆ</div>
            <div class="brand-sub">
                ã‚ˆã†ã“ãã€
                <span th:text="${loginUserName != null ? loginUserName : #authentication.name}">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                ã•ã‚“
            </div>
        </div>

        <!-- å³ï¼šãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
        <form class="logout-form" th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button class="btn btn-primary" type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </form>
    </div>
</header>

<!-- ===== drawer menu ===== -->
<nav id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
        <div class="drawer-title">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
        <button class="drawer-close" type="button" aria-label="é–‰ã˜ã‚‹" onclick="toggleMenu()">âœ•</button>
    </div>

    <ul class="drawer-list">
        <li><a th:href="@{/}">ğŸ  å•†å“ä¸€è¦§</a></li>
		<li>
			<a th:href="@{/mypage/orders}">ğŸ§¾ æ³¨æ–‡å±¥æ­´</a>
        </li>
        <li>
			<a th:href="@{/mypage/favorites}">ğŸ’– ãŠæ°—ã«å…¥ã‚Š</a>
        </li>


		<li sec:authorize="hasAnyRole('STAFF','ADMIN')">
			<a th:href="@{/staff/items}">ğŸ“¦ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå•†å“ç®¡ç†</a>
		</li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/orders}">ğŸ›  ã‚¹ã‚¿ãƒƒãƒ•ï¼šæ³¨æ–‡ç®¡ç†</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
   			<a th:href="@{/staff/items/new}" onclick="toggleMenu()">â• ã‚¹ã‚¿ãƒƒãƒ•ï¼šå•†å“ç™»éŒ²</a>
  		</li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/reports}">ğŸ›¡ ã‚¹ã‚¿ãƒƒãƒ•ï¼šé€šå ±ä¸€è¦§</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/attendance}">ğŸ•’ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå‹¤æ€ æ‰“åˆ»</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/attendance/manage}">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå‹¤æ€ ç®¡ç†ï¼ˆä¸€è¦§ï¼‰</a>
        </li>

        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/users}">ğŸ‘‘ ç®¡ç†è€…ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        </li>
    </ul>
</nav>

<!-- èƒŒæ™¯æš—è»¢ -->
<div id="backdrop" class="backdrop" onclick="toggleMenu()" aria-hidden="true"></div>

<!-- ===== page ===== -->
<main class="page">

    <section class="card">
        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <h1 class="page-title" style="margin:0;">ã‚¹ã‚¿ãƒƒãƒ•ï¼šé€šå ±ä¸€è¦§</h1>
            <a class="link" th:href="@{/}">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
        </div>

        <hr style="border:none; border-top:1px solid #e5e7eb; margin:16px 0;">

        <div th:if="${#lists.isEmpty(reports)}">
            <p style="margin:0; color:#6b7280;">ç¾åœ¨ã€é€šå ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>

        <div class="table-wrap" th:if="${!#lists.isEmpty(reports)}">
            <table class="table">
                <thead>
                <tr>
                    <th style="width:70px;">ID</th>
                    <th style="width:160px;">é€šå ±æ—¥æ™‚</th>
                    <th style="width:140px;">å•†å“</th>
                    <th style="width:140px;">ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿è€…</th>
                    <th style="width:110px;">è©•ä¾¡</th>
                    <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                    <th style="width:140px;">é€šå ±ç†ç”±</th>
                    <th style="width:150px;">åŒãƒ¬ãƒ“ãƒ¥ãƒ¼é€šå ±æ•°</th>
                    <th style="width:150px;">é€šå ±ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                    <th style="width:160px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th style="width:90px;">æ“ä½œ</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="rep : ${reports}">
                    <td th:text="${rep.id}"></td>

                    <td th:text="${#temporals.format(rep.createdAt,'yyyy/MM/dd HH:mm')}"></td>

                    <td th:text="${rep.review.item.name}"></td>

                    <td th:text="${rep.review.user.name}"></td>

                    <td>
                        <span th:each="i : ${#numbers.sequence(1,5)}"
                              th:text="${i <= rep.review.rating ? 'â˜…' : 'â˜†'}"></span>
                    </td>

                    <td th:text="${rep.review.comment}"></td>

                    <td th:text="${rep.reason != null ? rep.reason : 'ï¼ˆæœªé¸æŠï¼‰'}"></td>

                    <td th:text="${reportCounts[rep.review.id] ?: 0}"></td>

                    <td th:text="${rep.reportedBy != null ? rep.reportedBy.name : 'ï¼ˆä¸æ˜ï¼‰'}"></td>

                    <td>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <span class="badge" th:text="${rep.status}">NEW</span>

                            <!-- NEW â†’ DONE -->
                            <form th:if="${rep.status == 'NEW'}"
                                  th:action="@{'/staff/reports/' + ${rep.id} + '/done'}"
                                  method="post" style="display:inline; margin:0;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="btn" type="submit"
                                        style="background:#fff; border:1px solid #e5e7eb;"
                                        onclick="return confirm('å¯¾å¿œæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ');">
                                    DONEã¸
                                </button>
                            </form>

                            <!-- DONE â†’ NEW -->
                            <form th:if="${rep.status == 'DONE'}"
                                  th:action="@{'/staff/reports/' + ${rep.id} + '/reopen'}"
                                  method="post" style="display:inline; margin:0;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button class="btn" type="submit"
                                        style="background:#fff; border:1px solid #e5e7eb;"
                                        onclick="return confirm('NEWã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ');">
                                    NEWã¸
                                </button>
                            </form>
                        </div>
                    </td>

                    <td>
                        <a class="link" th:href="@{'/staff/reports/' + ${rep.id}}">è©³ç´°</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

    </section>

</main>

<script>
function toggleMenu() {
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("backdrop");

    const isOpen = drawer.classList.contains("open");
    if (isOpen) {
        drawer.classList.remove("open");
        backdrop.classList.remove("show");
        drawer.setAttribute("aria-hidden", "true");
        backdrop.setAttribute("aria-hidden", "true");
        document.body.classList.remove("no-scroll");
    } else {
        drawer.classList.add("open");
        backdrop.classList.add("show");
        drawer.setAttribute("aria-hidden", "false");
        backdrop.setAttribute("aria-hidden", "false");
        document.body.classList.add("no-scroll");
    }
}
</script>

</body>
</html>
