<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${item.name} + ' | å•†å“è©³ç´°'">å•†å“è©³ç´°</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<header class="site-header">
    <div class="header-inner">
        <button class="hamburger" type="button" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="toggleMenu()">â˜°</button>

        <div class="brand">
            <div class="brand-title">SUNåº— ãƒãƒƒãƒˆäºˆç´„ãƒ»é€šè²©ã‚µã‚¤ãƒˆ</div>
            <div class="brand-sub" th:if="${loginUserName != null}" th:text="'ã‚ˆã†ã“ãã€' + ${loginUserName} + ' ã•ã‚“'">
                ã‚ˆã†ã“ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã•ã‚“
            </div>
        </div>

        <form class="logout-form" th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button class="btn btn-primary" type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </form>
    </div>
</header>

<nav id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
        <div class="drawer-title">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
        <button class="drawer-close" type="button" aria-label="é–‰ã˜ã‚‹" onclick="toggleMenu()">âœ•</button>
    </div>

    <ul class="drawer-list">
        <li><a th:href="@{/}">ğŸ  å•†å“ä¸€è¦§</a></li>
        <li><a th:href="@{/mypage/orders}">ğŸ§¾ æ³¨æ–‡å±¥æ­´</a></li>
        <li><a th:href="@{/mypage/favorites}">ğŸ’– ãŠæ°—ã«å…¥ã‚Š</a></li>

		<li sec:authorize="hasAnyRole('STAFF','ADMIN')">
			<a th:href="@{/staff/items}">ğŸ“¦ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå•†å“ç®¡ç†</a>
		</li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/orders}">ğŸ›  ã‚¹ã‚¿ãƒƒãƒ•ï¼šæ³¨æ–‡ç®¡ç†</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/items/new}" onclick="toggleMenu()">â• ã‚¹ã‚¿ãƒƒãƒ•ï¼šå•†å“ç™»éŒ²</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/reports}">ğŸ›¡ ã‚¹ã‚¿ãƒƒãƒ•ï¼šé€šå ±ä¸€è¦§</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/attendance}">ğŸ•’ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå‹¤æ€ æ‰“åˆ»</a>
        </li>
        <li sec:authorize="hasAnyRole('STAFF','ADMIN')">
            <a th:href="@{/staff/attendance/manage}">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•ï¼šå‹¤æ€ ç®¡ç†ï¼ˆä¸€è¦§ï¼‰</a>
        </li>

        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/users}">ğŸ‘‘ ç®¡ç†è€…ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        </li>
    </ul>
</nav>

<div id="backdrop" class="backdrop" onclick="toggleMenu()" aria-hidden="true"></div>

<main class="page">

    <section class="card">
        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <div>
                <a class="link" th:href="@{/}">â† å•†å“ä¸€è¦§ã«æˆ»ã‚‹</a>
                <h1 class="page-title" th:text="${item.name}" style="margin-top:10px;">å•†å“å</h1>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <form th:action="@{'/favorites/add/' + ${item.id}}" method="post" th:if="${!isFavorite}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="btn btn-primary" type="submit">â¤ ãŠæ°—ã«å…¥ã‚Š</button>
                </form>
                <form th:action="@{'/favorites/remove/' + ${item.id}}" method="post" th:if="${isFavorite}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="btn" type="submit" style="background:#fff; border:1px solid #e5e7eb;">â˜… ãŠæ°—ã«å…¥ã‚Šæ¸ˆã¿</button>
                </form>
            </div>
        </div>

        <!-- â˜…å•†å“ç”»åƒï¼ˆå°ã•ãï¼†ä¸­å¤®å¯„ã›ï¼‰ -->
        <div th:if="${item.imageUrl != null and !#strings.isEmpty(item.imageUrl)}"
             style="margin-top:14px; display:flex; justify-content:center;">
            <img th:src="${item.imageUrl}" th:alt="${item.name}"
                 style="
                    width:320px;
                    height:320px;
                    border-radius:18px;
                    border:1px solid #e5e7eb;
                    object-fit:cover;
                 ">
        </div>

        <hr style="border:none; border-top:1px solid #e5e7eb; margin:16px 0;">

        <ul style="margin:0; padding-left:18px; line-height:1.8;">
            <li>èª¬æ˜ï¼š<span th:text="${item.description}"></span></li>
            <li>ä¾¡æ ¼ï¼š<span th:text="${item.price}"></span> å††</li>
            <li>åœ¨åº«ï¼š<span th:text="${item.stock}"></span> ç‚¹</li>
            <li>çŠ¶æ…‹ï¼š
                <span class="badge badge-sold" th:if="${item.status == 'SOLD'}">SOLDï¼ˆå£²ã‚Šåˆ‡ã‚Œï¼‰</span>
                <span class="badge badge-public" th:if="${item.status == 'PUBLIC'}">è²©å£²ä¸­</span>
            </li>
        </ul>
    </section>

    <section class="card" style="margin-top:16px;">
        <h2 style="margin:0 0 10px;">å¹³å‡è©•ä¾¡</h2>

        <div th:if="${reviewCount == 0}">
            <p style="margin:0; color:#6b7280;">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>

        <div th:if="${reviewCount > 0}">
            <p style="margin:0;">
                å¹³å‡è©•ä¾¡ï¼š
                <b th:text="${#numbers.formatDecimal(avgRating,1,1)}"></b>
                â˜…ï¼ˆ<span th:text="${reviewCount}"></span> ä»¶ï¼‰
            </p>
        </div>
    </section>

    <section class="card" style="margin-top:16px;">
        <h2 style="margin:0 0 10px;">äºˆç´„</h2>

        <div th:if="${item.status == 'PUBLIC' and item.stock > 0}">
            <form th:action="@{|/orders/confirm/${item.id}|}" method="get" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <label>æ•°é‡ï¼š</label>
                <input type="number" name="quantity" value="1" min="1" th:max="${item.stock}" style="padding:10px; border-radius:12px; border:1px solid #e5e7eb;">
                <button class="btn btn-primary" type="submit">ã“ã®å•†å“ã‚’äºˆç´„ã™ã‚‹</button>
            </form>
        </div>

        <div th:if="${item.status == 'SOLD' or item.stock == 0}">
            <p style="margin:0; color:#ef4444; font-weight:800;">ã“ã®å•†å“ã¯å£²ã‚Šåˆ‡ã‚Œã§ã™ã€‚</p>
        </div>
    </section>

    <section class="card" style="margin-top:16px;">
        <h2 style="margin:0 0 10px;">ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿</h2>

        <p th:if="${reviewMessage}" th:text="${reviewMessage}" style="color:green; font-weight:bold;"></p>

        <form th:action="@{'/reviews/add/' + ${item.id}}" method="post" style="display:grid; gap:10px; max-width:520px;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <div>
                <div style="font-weight:800; margin-bottom:6px;">è©•ä¾¡</div>
                <select name="rating" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e5e7eb;">
                    <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                    <option value="4">â˜…â˜…â˜…â˜…</option>
                    <option value="3">â˜…â˜…â˜…</option>
                    <option value="2">â˜…â˜…</option>
                    <option value="1">â˜…</option>
                </select>
            </div>

            <div>
                <div style="font-weight:800; margin-bottom:6px;">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                <textarea name="comment" rows="4" style="width:100%; padding:10px; border-radius:12px; border:1px solid #e5e7eb;"></textarea>
            </div>

            <button class="btn btn-primary" type="submit">ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿</button>
        </form>
    </section>

    <section class="card" style="margin-top:16px;">
        <h2 style="margin:0 0 10px;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h2>

        <div th:if="${#lists.isEmpty(reviews)}">
            <p style="margin:0; color:#6b7280;">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>

        <div th:if="${!#lists.isEmpty(reviews)}" class="table-wrap">
            <table class="table">
                <thead>
                    <tr>
                        <th>æ—¥æ™‚</th>
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                        <th>è©•ä¾¡</th>
                        <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>

                <tbody>
                    <tr th:each="r : ${reviews}">
                        <td th:text="${#temporals.format(r.createdAt,'yyyy/MM/dd HH:mm')}"></td>
                        <td th:text="${r.user.name}"></td>
                        <td>
                            <span th:each="i : ${#numbers.sequence(1,5)}"
                                  th:text="${i <= r.rating ? 'â˜…' : 'â˜†'}"></span>
                        </td>
                        <td th:text="${r.comment}"></td>

                        <td>
                            <span th:if="${loginUserId != null and r.user.id == loginUserId}">
                                <a class="link" th:href="@{'/reviews/edit/' + ${r.id}}">ç·¨é›†</a>

                                <form th:action="@{'/reviews/delete/' + ${r.id}}"
                                      method="post" style="display:inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button class="btn" type="submit"
                                            style="background:#fff; border:1px solid #e5e7eb;"
                                            onclick="return confirm('è‡ªåˆ†ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                                        å‰Šé™¤
                                    </button>
                                </form>
                            </span>

                            <span th:if="${loginUserId == null or r.user.id != loginUserId}">
                                <a class="link" th:href="@{'/reviews/report/' + ${r.id}}">é€šå ±</a>
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

</main>

<script>
function toggleMenu() {
    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("backdrop");

    const isOpen = drawer.classList.contains("open");
    if (isOpen) {
        drawer.classList.remove("open");
        backdrop.classList.remove("show");
        drawer.setAttribute("aria-hidden", "true");
        backdrop.setAttribute("aria-hidden", "true");
        document.body.classList.remove("no-scroll");
    } else {
        drawer.classList.add("open");
        backdrop.classList.add("show");
        drawer.setAttribute("aria-hidden", "false");
        backdrop.setAttribute("aria-hidden", "false");
        document.body.classList.add("no-scroll");
    }
}
</script>

</body>
</html>
